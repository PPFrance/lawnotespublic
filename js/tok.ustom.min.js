/*
     http://www.opensource.org/licenses/BSD-3-Clause New BSD license
 @version     2.6
*/
(function(b){function k(a,c){if(!c.data("tokenize")){var d=new b.tokenize(b.extend({},b.fn.tokenize.defaults,a));c.data("tokenize",d);d.init(c)}return c.data("tokenize")}var h=!1,f=null;b.tokenize=function(a){void 0==a&&(a=b.fn.tokenize.defaults);this.options=a};b.extend(b.tokenize.prototype,{init:function(a){var c=this;this.select=a.attr("multiple","multiple").css({margin:0,padding:0,border:0}).hide();this.container=b("<div />").attr("class",this.select.attr("class")).addClass("Tokenize");1==this.options.maxElements&&
this.container.addClass("OnlyOne");this.dropdown=b("<ul />").addClass("Dropdown");this.options.maxDropdownHeight&&(this.dropdown.css("max-height",this.options.maxDropdownHeight),this.dropdown.css("overflow-y","scroll"));this.tokensContainer=b("<ul />").addClass("TokensContainer");this.options.autosize&&this.tokensContainer.addClass("Autosize");this.searchToken=b("<li />").addClass("TokenSearch").appendTo(this.tokensContainer);this.searchInput=b('<input type="tokes"/>').appendTo(this.searchToken);
0<this.options.searchMaxLength&&this.searchInput.attr("maxlength",this.options.searchMaxLength);this.select.prop("disabled")&&this.disable();this.options.sortable&&("undefined"!=typeof b.ui?this.tokensContainer.sortable({items:"li.Token",cursor:"move",placeholder:"Token MovingShadow",forcePlaceholderSize:!0,update:function(){c.updateOrder()},start:function(){c.searchToken.hide()},stop:function(){c.searchToken.show()}}).disableSelection():(this.options.sortable=!1,console.error("jQuery UI is not loaded, sortable option has been disabled")));
this.container.append(this.tokensContainer).append(this.dropdown).insertAfter(this.select);this.tokensContainer.on("click",function(a){a.stopImmediatePropagation();c.searchInput.get(0).focus();c.updatePlaceholder();c.dropdown.is(":hidden")?c.search():(c.dropdownHide(),c.searchInput.get(0).blur())});this.searchInput.on("blur",function(){c.tokensContainer.removeClass("Focused");c.options.hasSearchButton&&c.searchButton.removeClass("BtnFocused")});this.searchInput.on("focus click",function(){c.tokensContainer.addClass("Focused");
c.options.hasSearchButton&&c.searchButton.addClass("BtnFocused");c.options.displayDropdownOnFocus&&"select"==c.options.datas&&c.search()});this.searchInput.on("keydown",function(a){c.resizeSearchInput();c.keydown(a)});this.searchInput.on("keyup",function(a){c.keyup(a)});this.searchInput.on("keypress",function(a){c.keypress(a)});this.searchInput.on("paste",function(){setTimeout(function(){c.resizeSearchInput()},10);setTimeout(function(){var a=c.searchInput.val().split(",");1<a.length&&b.each(a,function(a,
b){c.tokenAdd(b.trim(),"")})},20)});b("body").on("click",function(){c.dropdownHide();1==c.options.maxElements&&c.searchInput.val()&&c.tokenAdd(c.searchInput.val(),"")});this.resizeSearchInput();this.remap(!0);this.updatePlaceholder();this.options.hasSearchButton&&(this.searchContainer=b('<div class="searchBtnWrapper"></div>').appendTo(this.tokensContainer),this.searchButton=b('<a class="tokenize-search-btn"><i class="material-icons">search</i></a>').appendTo(this.searchContainer),b(".tokenize-search-btn").click(this.options.onPressEnterOrClickSearch))},
updateOrder:function(){if(this.options.sortable){var a,c,d=this;b.each(this.tokensContainer.sortable("toArray",{attribute:"data-value"}),function(e,g){c=b('option[value="'+g+'"]',d.select);void 0==a?c.prependTo(d.select):a.after(c);a=c});this.options.onReorder(this)}},updatePlaceholder:function(){this.options.placeholder&&(void 0==this.placeholder&&(this.placeholder=b("<li />").addClass("Placeholder").html(this.options.placeholder),this.placeholder.insertBefore(b("li:first-child",this.tokensContainer))),
0==this.searchInput.val().length&&0==b("li.Token",this.tokensContainer).length?this.placeholder.show():this.placeholder.hide())},dropdownShow:function(){this.dropdown.velocity("fadeIn","150ms");this.options.onDropdownShow(this)},dropdownPrev:function(){0<b("li.Hover",this.dropdown).length?b("li.Hover",this.dropdown).is("li:first-child")?(b("li.Hover",this.dropdown).removeClass("Hover"),b("li:last-child",this.dropdown).addClass("Hover")):b("li.Hover",this.dropdown).removeClass("Hover").prev().addClass("Hover"):
b("li:first",this.dropdown).addClass("Hover")},dropdownNext:function(){0<b("li.Hover",this.dropdown).length?b("li.Hover",this.dropdown).is("li:last-child")?(b("li.Hover",this.dropdown).removeClass("Hover"),b("li:first-child",this.dropdown).addClass("Hover")):b("li.Hover",this.dropdown).removeClass("Hover").next().addClass("Hover"):b("li:first",this.dropdown).addClass("Hover")},dropdownAddItem:function(a,c,d){d=d||c;var e=this.options.onDrawDropdownItem(a,c,this);e&&(d=e);if(!b('li[data-value="'+a+
'"]',this.tokensContainer).length){var g=this,e=b("<li />").attr("data-value",a).attr("data-text",c).html(d).on("click",function(a){a.stopImmediatePropagation();g.tokenAdd(b(this).attr("data-value"),b(this).attr("data-text"));g.options.searchOnSelect&&setTimeout(function(){g.options.onPressEnterOrClickSearch()},10)}).on("mouseover",function(){b(this).addClass("Hover")}).on("mouseout",function(){b("li",g.dropdown).removeClass("Hover")});this.dropdown.append(e);this.options.onDropdownAddItem(a,c,d,
this)}return this},dropdownHide:function(){this.dropdownReset();this.dropdown.velocity("fadeOut","150ms")},dropdownReset:function(){this.dropdown.html("")},resizeSearchInput:function(){this.searchInput.attr("size",Number(this.searchInput.val().length)+5);this.updatePlaceholder()},resetSearchInput:function(){this.searchInput.val("");this.resizeSearchInput()},resetPendingTokens:function(){b("li.PendingDelete",this.tokensContainer).removeClass("PendingDelete")},keypress:function(a){var b=!1;Array.isArray(this.options.delimiter)?
0<=this.options.delimiter.indexOf(String.fromCharCode(a.which))&&(b=!0):String.fromCharCode(a.which)==this.options.delimiter&&(b=!0);b&&(a.preventDefault(),this.tokenAdd(this.searchInput.val(),""))},keydown:function(a){switch(a.keyCode){case 8:0==this.searchInput.val().length&&(a.preventDefault(),b("li.Token.PendingDelete",this.tokensContainer).length?this.tokenRemove(b("li.Token.PendingDelete").attr("data-value")):b("li.Token:last",this.tokensContainer).addClass("PendingDelete"),this.dropdownHide());
break;case 9:case 13:if(b("li.Hover",this.dropdown).length){var c=b("li.Hover",this.dropdown);a.preventDefault();this.tokenAdd(c.attr("data-value"),c.attr("data-text"));this.options.searchOnSelect&&setTimeout(function(){b(".tokenize-search-btn").click()},10)}else if(this.searchInput.val())a.preventDefault(),this.tokenAdd(this.searchInput.val(),""),b(".tokenize-search-btn").click();else this.options.onPressEnterOrClickSearch();this.resetPendingTokens();break;case 27:this.resetSearchInput();this.dropdownHide();
this.resetPendingTokens();break;case 38:a.preventDefault();this.dropdownPrev();break;case 40:a.preventDefault();this.dropdownNext();break;default:this.resetPendingTokens()}},keyup:function(a){if(!h)switch(this.updatePlaceholder(),a.keyCode){case 9:case 13:case 27:case 38:case 40:break;case 8:this.searchInput.val()?this.search():this.dropdownHide();break;default:this.searchInput.val()&&this.search()}},search:function(){setTimeout(function(){h=!1},300);h=!0;var a=this,c=1;if(0<this.options.maxElements&&
b("li.Token",this.tokensContainer).length>=this.options.maxElements||this.searchInput.val().length<this.options.searchMinLength)return!1;if("select"==this.options.datas){var d=!1,e=new RegExp(this.searchInput.val().replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),"i");this.dropdownReset();b("option",this.select).not(":selected, :disabled").each(function(){if(c<=a.options.nbDropdownElements)e.test(b(this).html())&&(a.dropdownAddItem(b(this).attr("value"),b(this).html()),d=!0,c++);else return!1});d?(0<this.searchInput.val().length&&
b("li:first",this.dropdown).addClass("Hover"),this.dropdownShow()):this.dropdownHide()}else this.debounce(function(){b.ajax({url:a.options.datas,data:a.options.searchParam+"="+encodeURIComponent(a.searchInput.val()),dataType:a.options.dataType,success:function(d){if(d&&(a.dropdownReset(),b.each(d,function(b,d){if(c<=a.options.nbDropdownElements){var e;d[a.options.htmlField]&&(e=d[a.options.htmlField]);a.dropdownAddItem(d[a.options.valueField],d[a.options.textField],e);c++}else return!1}),b("li",a.dropdown).length))return b("li:first",
a.dropdown).addClass("Hover"),a.dropdownShow(),!0;a.dropdownHide()},error:function(b,c){a.options.onAjaxError(a,b,c)}})},this.options.debounce)},debounce:function(a,b){var d=this,e=arguments;f&&clearTimeout(f);f=setTimeout(function(){a.apply(d,e);f=null},b||this.options.debounce)},tokenAdd:function(a,c,d){a=this.escape(a).trim();if(void 0==a||""==a)return this;c=c||a;d=d||!1;if(0<this.options.maxElements&&b("li.Token",this.tokensContainer).length>=this.options.maxElements)return this.resetSearchInput(),
this;var e=this,g=b("<a />").addClass("Close").html("&#215;").on("click",function(b){b.stopImmediatePropagation();e.tokenRemove(a)});if(b('option[value="'+a+'"]',this.select).length){if(!d&&(!0===b('option[value="'+a+'"]',this.select).attr("selected")||!0===b('option[value="'+a+'"]',this.select).prop("selected")))this.options.onDuplicateToken(a,c,this);b('option[value="'+a+'"]',this.select).attr("selected",!0).prop("selected",!0)}else if(this.options.newElements||!this.options.newElements&&0<b('li[data-value="'+
a+'"]',this.dropdown).length){var f=b("<option />").attr("selected",!0).attr("value",a).attr("data-type","custom").prop("selected",!0).html(c);this.select.append(f)}else return this.resetSearchInput(),this;if(0<b('li.Token[data-value="'+a+'"]',this.tokensContainer).length)return this;(f=this.options.onFormatToken(a,c,this))&&(c=f);b("<li />").addClass("Token").attr("data-value",a).append("<span>"+c+"</span>").prepend(g).insertBefore(this.searchToken);if(!d)this.options.onAddToken(a,c,this);this.resetSearchInput();
this.dropdownHide();this.updateOrder();return this},tokenRemove:function(a){var c=b('option[value="'+a+'"]',this.select);"custom"==c.attr("data-type")?c.remove():c.removeAttr("selected").prop("selected",!1);b('li.Token[data-value="'+a+'"]',this.tokensContainer).remove();this.options.onRemoveToken(a,this);this.resizeSearchInput();this.dropdownHide();this.updateOrder();return this},clear:function(){var a=this;b("li.Token",this.tokensContainer).each(function(){a.tokenRemove(b(this).attr("data-value"))});
this.options.onClear(this);this.dropdownHide();return this},disable:function(){this.select.prop("disabled",!0);this.searchInput.prop("disabled",!0);this.container.addClass("Disabled");this.options.sortable&&this.tokensContainer.sortable("disable");return this},enable:function(){this.select.prop("disabled",!1);this.searchInput.prop("disabled",!1);this.container.removeClass("Disabled");this.options.sortable&&this.tokensContainer.sortable("enable");return this},remap:function(a){var c=this,d=b("option:selected",
this.select);a=a||!1;this.clear();d.each(function(){c.tokenAdd(b(this).val(),b(this).html(),a)});return this},toArray:function(){var a=[];b("option:selected",this.select).each(function(){a.push(b(this).val())});return a},escape:function(a){var b=document.createElement("div");b.innerHTML=a;a=b.textContent||b.innerText||"";return String(a).replace(/["]/g,function(){return""})}});b.fn.tokenize=function(a){a=a||{};var c=this.filter("select");if(1<c.length){var d=[];c.each(function(){d.push(k(a,b(this)))});
return d}return k(a,b(this))};b.fn.tokenize.defaults={datas:"select",placeholder:!1,searchParam:"search",searchMaxLength:0,searchMinLength:0,debounce:0,delimiter:",",newElements:!0,autosize:!1,nbDropdownElements:16,maxDropdownHeight:null,displayDropdownOnFocus:!1,searchOnSelect:!1,hasSearchButton:!1,maxElements:0,sortable:!1,dataType:"json",valueField:"value",textField:"text",htmlField:"html",onPressEnterOrClickSearch:function(){},onAddToken:function(){},onFormatToken:function(){},onRemoveToken:function(){},
onClear:function(){},onReorder:function(){},onDropdownAddItem:function(){},onDrawDropdownItem:function(){},onDropdownShow:function(){},onDuplicateToken:function(){},onAjaxError:function(){}}})(jQuery,"tokenize");
